name: Build

on:
  push:
    branches: [main, feat/*]
    tags: ['v*']
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: linux
            arch: arm64
            runner: ubuntu-latest
          - os: darwin
            arch: amd64
            runner: macos-latest
          - os: darwin
            arch: arm64
            runner: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache-dependency-path: llm_resolver/go.sum

      - name: Install xcaddy
        run: go install github.com/caddyserver/xcaddy/cmd/xcaddy@latest

      - name: Build Caddy
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
        run: |
          xcaddy build \
            --with github.com/contember/tudy/llm_resolver=${{ github.workspace }}/llm_resolver \
            --output caddy

      - name: Build CLI
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          cd cmd/cli
          go build -ldflags="-s -w" -o ../../cli .

      - name: Build menubar app (macOS only)
        if: matrix.os == 'darwin'
        env:
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 1
        run: |
          cd cmd/menubar
          go build -ldflags="-s -w" -o ../../menubar .

      - name: Create tarball
        run: |
          if [ "${{ matrix.os }}" = "darwin" ]; then
            tar czf caddy-${{ matrix.os }}-${{ matrix.arch }}.tar.gz caddy cli menubar Caddyfile
          else
            tar czf caddy-${{ matrix.os }}-${{ matrix.arch }}.tar.gz caddy cli Caddyfile
          fi
          shasum -a 256 caddy-${{ matrix.os }}-${{ matrix.arch }}.tar.gz > caddy-${{ matrix.os }}-${{ matrix.arch }}.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: caddy-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            caddy-${{ matrix.os }}-${{ matrix.arch }}.tar.gz
            caddy-${{ matrix.os }}-${{ matrix.arch }}.tar.gz.sha256

  docker:
    name: Build Docker image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: tudy:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  release:
    name: Release
    needs: [build, docker]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          for dir in artifacts/caddy-*; do
            cp "$dir"/*.tar.gz "release/" 2>/dev/null || true
            cp "$dir"/*.sha256 "release/" 2>/dev/null || true
          done
          ls -la release/

      - name: Update Homebrew formula
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}

          # Read SHA256 values
          SHA_DARWIN_ARM64=$(cat release/caddy-darwin-arm64.tar.gz.sha256 | awk '{print $1}')
          SHA_DARWIN_AMD64=$(cat release/caddy-darwin-amd64.tar.gz.sha256 | awk '{print $1}')
          SHA_LINUX_ARM64=$(cat release/caddy-linux-arm64.tar.gz.sha256 | awk '{print $1}')
          SHA_LINUX_AMD64=$(cat release/caddy-linux-amd64.tar.gz.sha256 | awk '{print $1}')

          # Update formula using awk for precise replacements
          awk -v ver="$VERSION" \
              -v sha_darwin_arm64="$SHA_DARWIN_ARM64" \
              -v sha_darwin_amd64="$SHA_DARWIN_AMD64" \
              -v sha_linux_arm64="$SHA_LINUX_ARM64" \
              -v sha_linux_amd64="$SHA_LINUX_AMD64" '
            /version "/ { gsub(/"[0-9]+\.[0-9]+\.[0-9]+"/, "\"" ver "\"") }
            /on_macos do/,/end/ {
              if (/on_arm do/) { in_macos_arm=1 }
              if (/on_intel do/) { in_macos_arm=0; in_macos_intel=1 }
              if (in_macos_arm && /sha256 "/) { gsub(/"[a-f0-9]{64}"/, "\"" sha_darwin_arm64 "\"") }
              if (in_macos_intel && /sha256 "/) { gsub(/"[a-f0-9]{64}"/, "\"" sha_darwin_amd64 "\""); in_macos_intel=0 }
            }
            /on_linux do/,/end/ {
              if (/on_arm do/) { in_linux_arm=1 }
              if (/on_intel do/) { in_linux_arm=0; in_linux_intel=1 }
              if (in_linux_arm && /sha256 "/) { gsub(/"[a-f0-9]{64}"/, "\"" sha_linux_arm64 "\"") }
              if (in_linux_intel && /sha256 "/) { gsub(/"[a-f0-9]{64}"/, "\"" sha_linux_amd64 "\""); in_linux_intel=0 }
            }
            { print }
          ' Formula/tudy.rb > Formula/tudy.rb.tmp
          mv Formula/tudy.rb.tmp Formula/tudy.rb

          cat Formula/tudy.rb

      - name: Commit formula update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/tudy.rb
          git commit -m "chore: update homebrew formula for ${GITHUB_REF#refs/tags/}"
          git push origin HEAD:main

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*.tar.gz
          generate_release_notes: true
