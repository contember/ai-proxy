services:
  resolver:
    image: oven/bun:1
    working_dir: /app
    command: bun run src/traefik/server.ts
    user: root
    privileged: true
    environment:
      - RESOLVER_PORT=3001
      - RESOLVER_HOST=127.0.0.1
      - MODEL=${MODEL:-anthropic/claude-haiku-4.5}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - COMPOSE_PROJECT=proxy-traefik
    volumes:
      # Mount source code
      - .:/app
      # Docker CLI and socket for container discovery
      - /usr/bin/docker:/usr/bin/docker:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    # Use host network for full visibility of local processes
    network_mode: host
    pid: host
    restart: unless-stopped

  traefik:
    image: traefik:v3.2
    volumes:
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      - ./traefik/certs:/etc/traefik/certs:ro
    # Use host network so Traefik can:
    # 1. Access resolver on localhost:3001
    # 2. Access local processes on localhost:port
    # 3. Bind to ports 80 and 443
    network_mode: host
    extra_hosts:
      # Map "resolver" hostname to localhost for HTTP provider
      - "resolver:127.0.0.1"
    depends_on:
      - resolver
    restart: unless-stopped
